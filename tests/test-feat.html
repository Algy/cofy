<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Feat.js - JavaScript Persistent Data Structure Test</title>
<style>
  html, body { margin: 0; padding: 0; }
  body { font: 12px Arial, sans-serif; background: #FFF; color: #000; padding: 20px; }
  h1 { margin: 0; padding: 0 0 20px; font: bold 24px/1 Arial, sans-serif; text-align: left; }
  .download { padding: 0 0 20px; font-weight: bold; }
  .download a { color: #036; }
  #result { padding: 3px 10px; }
  #log { padding: 10px; font-family: monospace; }
</style>
<script>

var TESTS = (function (nil) {
  'use strict';
  return {
    sorted_map: {

      create_empty: function () {
        this.isSame(FEAT.sortedMap().count(), 0);
        this.isSame(FEAT.sortedMap({}).count(), 0);
      },

      create_from_object: function () {
        var map = FEAT.sortedMap({a: 1, b: 2});
        this.isSame(map.get('a'), 1);
        this.isSame(map.get('b'), 2);
        this.isUndefined(map.get('c'));
        this.isSame(map.get('c', 3), 3);
        this.isTrue(map.contains('a'));
        this.isTrue(map.contains('b'));
        this.isFalse(map.contains('c'));
      },

      adding_items: function () {
        var i, a = ['y', 'a', 'c', 'z', 'b', 'x'],
            map1 = FEAT.sortedMap(),
            map2 = map1;
        for (i = 0; i < a.length; i++)
          map2 = map2.assoc(a[i], i + 1);
        this.isSame(map1.count(), 0);
        this.isSame(map2.count(), a.length);
        for (i = 0; i < a.length; i++)
          this.isSame(map2.get(a[i]), i + 1);
      },

      removing_items: function () {
        var i, a = ['c', 'z', 'y', 'a', 'x', 'b'],
            map1 = FEAT.sortedMap(),
            map2;
        for (i = 0; i < a.length; i++)
          map1 = map1.assoc(a[i], i + 1);
        map2 = map1;
        for (i = 0; i < a.length / 2 | 0; i++)
          map2 = map2.dissoc(a[i]);
        this.isSame(map2.count(), a.length / 2 | 0);
        for (i = 0; i < a.length / 2 | 0; i++)
          this.isUndefined(map2.get(a[i]));
        for (i = a.length / 2 | 0; i < a.length; i++)
          this.isSame(map2.get(a[i]), i + 1);
        for (i = a.length / 2 | 0; i < a.length; i++)
          map2 = map2.dissoc(a[i]);
        this.isSame(map1.count(), a.length);
        this.isSame(map2.count(), 0);
        for (i = 0; i < a.length; i++)
          this.isUndefined(map2.get(a[i]));
      },

      convert_to_object: function () {
        var key, o1 = { a: 1, b: 2, c: 3 }, o2 = FEAT.sortedMap(o1).toObject();
        this.isNotSame(o1, o2);
        for (key in o1)
          this.isSame(o1[key], o2[key]);
        for (key in o2)
          this.isSame(o2[key], o1[key]);
      },

      convert_to_string: function () {
        var map = FEAT.sortedMap({ c: 3, a: 1, b: 2 });
        this.isSame(map.toString(), '{ a: 1, b: 2, c: 3 }');
        this.isSame(FEAT.sortedMap().toString(), '{}');
      },

      getting_keys_sorted_default: function () {
        var map = FEAT.sortedMap({ c: 1, a: 2, b: 3 });
        this.isSame(map.keys().toString(), 'a,b,c');
      },

      getting_keys_sorted_with_comparator: function () {
        var map = FEAT.sortedMap({ c: 1, a: 2, b: 3 }, function (a, b) { return a > b; });
        this.isSame(map.keys().toString(), 'c,b,a');
      },

      getting_values_default: function () {
        var map = FEAT.sortedMap({ c: 1, a: 2, b: 3 });
        this.isSame(map.values().toString(), '2,3,1');
      },

      getting_values_with_comparator: function () {
        var map = FEAT.sortedMap({ c: 1, a: 2, b: 3 }, function (a, b) { return a > b; });
        this.isSame(map.values().toString(), '1,3,2');
      }
    },

    cow_map: {

      adding_items: function () {
        var i, a = ['y', 'a', 'c', 'z', 'b', 'x'],
            map1 = FEAT.cowMap(),
            map2 = map1;
        for (i = 0; i < a.length; i++)
          map2 = map2.assoc(a[i], i + 1);
        this.isNotSame(map1, map2);
        for (i = 0; i < a.length; i++)
          this.isUndefined(map1.get(a[i]));
        for (i = 0; i < a.length; i++)
          this.isSame(map2.get(a[i]), i + 1);
      },

      removing_items: function () {
        var i, a = ['c', 'z', 'y', 'a', 'x', 'b'],
            map1 = FEAT.cowMap(),
            map2;
        for (i = 0; i < a.length; i++)
          map1 = map1.assoc(a[i], i + 1);
        map2 = map1;
        for (i = 0; i < a.length / 2 | 0; i++)
          map2 = map2.dissoc(a[i]);
        for (i = 0; i < a.length / 2 | 0; i++)
          this.isUndefined(map2.get(a[i]));
        for (i = a.length / 2 | 0; i < a.length; i++)
          this.isSame(map2.get(a[i]), i + 1);
        for (i = a.length / 2 | 0; i < a.length; i++)
          map2 = map2.dissoc(a[i]);
        for (i = 0; i < a.length; i++)
          this.isSame(map1.get(a[i]), i + 1);
        for (i = 0; i < a.length; i++)
          this.isUndefined(map2.get(a[i]));
      },

      copying_to_object: function () {
        var i, a = ['y', 'a', 'c', 'z', 'b', 'x'],
            map = FEAT.cowMap(a),
            b = map.toObject(),
            c = map.toObject({ o: 1 });
        for (i = 0; i < a.length; i++)
          this.isSame(map.get(a[i]), b[a[i]]);
        for (i = 0; i < a.length; i++)
          this.isSame(map.get(a[i]), c[a[i]]);
        this.isSame(c.o, 1);
      },

      convert_to_string: function () {
        var map = FEAT.cowMap({ c: 3, a: 1, b: 2 });
        this.isTrue(/\{ [abc]: [123], [abc]: [123], [abc]: [123] \}/.test(map.toString()));
        this.isSame(FEAT.cowMap().toString(), '{}');
      },

      adding_items_directly: function () {
        var i, a = ['y', 'a', 'c', 'z', 'b', 'x'],
            map1 = {},
            map2 = map1;
        for (i = 0; i < a.length; i++)
          map2 = FEAT.assoc(map2, a[i], i + 1);
        this.isNotSame(map1, map2);
        for (i = 0; i < a.length; i++)
          this.isUndefined(map1[a[i]]);
        for (i = 0; i < a.length; i++)
          this.isSame(map2[a[i]], i + 1);
      },

      removing_items_directly: function () {
        var i, a = ['c', 'z', 'y', 'a', 'x', 'b'],
            map1 = {},
            map2;
        for (i = 0; i < a.length; i++)
          map1 = FEAT.assoc(map1, a[i], i + 1);
        map2 = map1;
        for (i = 0; i < a.length / 2 | 0; i++)
          map2 = FEAT.dissoc(map2, a[i]);
        for (i = 0; i < a.length / 2 | 0; i++)
          this.isUndefined(map2[a[i]]);
        for (i = a.length / 2 | 0; i < a.length; i++)
          this.isSame(map2[a[i]], i + 1);
        for (i = a.length / 2 | 0; i < a.length; i++)
          map2 = FEAT.dissoc(map2, a[i]);
        for (i = 0; i < a.length; i++)
          this.isSame(map1[a[i]], i + 1);
        for (i = 0; i < a.length; i++)
          this.isUndefined(map2[a[i]]);
      }
    },

    vector: {

      create_empty: function () {
        this.isSame(FEAT.vector().count(), 0);
        this.isSame(FEAT.vector([]).count(), 0);
      },

      create_from_object: function () {
        var vector = FEAT.vector([1, 2, 3]);
        this.isSame(vector.count(), 3);
        this.isSame(vector.get(0), 1);
        this.isSame(vector.get(1), 2);
        this.isSame(vector.get(2), 3);
        this.isUndefined(vector.get(3));
      },

      adding_values: function () {
        var i, vector = FEAT.vector();
        for (i = 0; i < 33; i++)
          vector = vector.push(i);
        this.isSame(vector.count(), 33);
        this.isSame(vector.get(0), 0);
        this.isSame(vector.get(1), 1);
        this.isSame(vector.get(7), 7);
        this.isSame(vector.get(8), 8);
        this.isSame(vector.get(15), 15);
        this.isSame(vector.get(16), 16);
        this.isSame(vector.get(31), 31);
        this.isSame(vector.get(32), 32);
      },

      setting_values: function () {
        var i, vector = FEAT.vector();
        for (i = 0; i < 33; i++)
          vector = vector.push(i);
        for (i = 0; i < 33; i++)
          vector = vector.set(i, i + 10);
        this.isSame(vector.get(0), 10);
        this.isSame(vector.get(1), 11);
        this.isSame(vector.get(7), 17);
        this.isSame(vector.get(8), 18);
        this.isSame(vector.get(15), 25);
        this.isSame(vector.get(16), 26);
        this.isSame(vector.get(31), 41);
        this.isSame(vector.get(32), 42);
      },

      removing_values: function () {
        var i, vector = FEAT.vector();
        for (i = 0; i < 33; i++)
          vector = vector.push(i);
        this.isSame(vector.count(), 33);
        for (i = 0; i < 32; i++)
          vector = vector.pop();
        this.isSame(vector.count(), 1);
        vector = vector.pop();
        this.isSame(vector.count(), 0);
        vector = vector.pop();
        this.isSame(vector.count(), 0);
      },

      convert_to_array: function () {
        var i, a1 = [1, 2, 3], a2 = FEAT.vector(a1).toArray();
        this.isNotSame(a1, a2);
        this.isSame(a1.length, a2.length);
        for (i = 0; i < a1.length; i++)
          this.isSame(a1[i], a2[i]);
      },

      convert_to_string: function () {
        var vec = FEAT.vector([1, 2, 3]);
        this.isSame(vec.toString(), '[1, 2, 3]');
        this.isSame(FEAT.vector().toString(), '[]');
      },
    }
  };
}());
</script>
</head>

<body onload="RUNNER.test()">
<h1>Feat.js - JavaScript Persistent Data Structures</h1>
<div class="download"><a href="https://github.com/josef-jelinek/cofy/blob/master/lang/feat-vector.js">feat-vector.js on github</a></div>
<div class="download"><a href="https://github.com/josef-jelinek/cofy/blob/master/lang/feat-sorted-map.js">feat-sorted-map.js on github</a></div>
<div class="download"><a href="https://github.com/josef-jelinek/cofy/blob/master/lang/feat-cow-map.js">feat-cow-map.js on github</a></div>
<div class="download"><a href="https://github.com/josef-jelinek/cofy/blob/master/tests/test-feat.html">feat.js tests on github (this file)</a></div>
<div id="result" style="background: #6CF">Running tests...</div>
<div id="log"></div>
<div id="time1"></div>
<div id="time2"></div>
<div id="time3"></div>
<div><button onclick="RUNNER.measure();">Measure performance</button> (may block browser for some time)</div>
<script src="../tools/test.js"></script>
<script src="../lang/feat-vector.js"></script>
<script src="../lang/feat-sorted-map.js"></script>
<script src="../lang/feat-cow-map.js"></script>
<script>
var RUNNER = (function () {
  'use strict';
  var time, time_vector, time_sorted_map, time_cow_map;

  time = function (f) {
    var time = new Date().getTime();
    f();
    return new Date().getTime() - time;
  };

  time_vector = function () {
    var i, t = 0, n = 10000, vec = FEAT.vector(), wr, rd, rm;

    wr = Math.round(n * 1000 / time(function () {
      for (i = 0; i < n; i++)
        vec = vec.push(i);
      for (i = 0; i < n; i++)
        vec = vec.set(i, i + 1);
    }));

    rd = Math.round(n * 1000 / time(function () {
      for (i = 0; i < n; i++)
        t += vec.get(i);
    }));

    rm = Math.round(n * 1000 / time(function () {
      for (i = 0; i < n; i++)
        vec = vec.pop();
    }));

    return 'Persistent vector: ' + rd + ' reads/s, ' + wr + ' writes/s, ' + rm + ' deletes/s (tested for ' + n + ' items)';
  };

  time_sorted_map = function () {
    var i, t = 0, n = 10000, map = FEAT.sortedMap(), wr, rd, rm;

    wr = Math.round(n * 1000 / time(function () {
      for (i = 0; i < n; i++)
        map = map.assoc('a' + i * 113 % n, i);
      for (i = 0; i < n; i++)
        map = map.assoc('a' + i * 113 % n, i + 1);
    }));

    rd = Math.round(n * 1000 / time(function () {
      for (i = 0; i < n; i++)
        t += map.get('a' + i);
    }));

    rm = Math.round(n * 1000 / time(function () {
      for (i = 0; i < n; i++)
        map = map.dissoc('a' + i);
    }));

    return 'Persistent sorted map: ' + rd + ' reads/s, ' + wr + ' writes/s, ' + rm + ' deletes/s (tested for ' + n + ' items)';
  };

  time_cow_map = function () {
    var i, t = 0, n = 500, map = FEAT.cowMap(), wr, rd, rm;

    wr = Math.round(n * 1000 / time(function () {
      for (i = 0; i < n; i++)
        map = map.assoc('a' + i * 113 % n, i);
      for (i = 0; i < n; i++)
        map = map.assoc('a' + i * 113 % n, i + 1);
    }));

    rd = Math.round(n * 1000 / time(function () {
      for (i = 0; i < n; i++)
        t += map.get('a' + i);
    }));

    rm = Math.round(n * 1000 / time(function () {
      for (i = 0; i < n; i++)
        map = map.dissoc('a' + i);
    }));

    return 'Copy-on-write map: ' + wr + ' writes/s, ' + rm + ' deletes/s (tested ONLY for ' + n + ' items)';
  };

  return {

    test: function () {
      var result = document.getElementById('result'),
          log = document.getElementById('log');
      TEST.init(result, log)(TESTS);
    },

    measure: function () {
      var time1 = document.getElementById('time1'),
          time2 = document.getElementById('time2'),
          time3 = document.getElementById('time3');
      time1.innerHTML = time_vector();
      time2.innerHTML = time_sorted_map();
      time3.innerHTML = time_cow_map();
    }
  };
}());
</script>
</body>
</html>

